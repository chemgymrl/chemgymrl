<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>chemistrylab.vessel &mdash; chemistrygym 1.5.7 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            chemistrygym
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chemistrylab.html">chemistrylab package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">chemistrygym</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">chemistrylab.vessel</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for chemistrylab.vessel</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">chemistrylab.extract_algorithms</span> <span class="kn">import</span> <span class="n">separate</span><span class="c1">#separate_cc as separate</span>

<div class="viewcode-block" id="Event"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Event">[docs]</a><span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameter</span><span class="p">:</span> <span class="nb">tuple</span>
    <span class="n">other_vessel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span></div>

<span class="c1">#Apparently documenting this isn&#39;t trivial :(</span>
<span class="n">Event</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;The registered name of the event function.&quot;</span>
<span class="n">Event</span><span class="o">.</span><span class="n">parameter</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;The parameters of the registered event function&quot;</span>
<span class="n">Event</span><span class="o">.</span><span class="n">other_vessel</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;The other vessel needed for this event if requred (ex the target vessel when pouring).&quot;</span>


<span class="k">def</span> <span class="nf">_rebuild_solute_dict</span><span class="p">(</span><span class="n">solvent_dict</span><span class="p">,</span> <span class="n">solute_dict</span><span class="p">,</span> <span class="n">solvents</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recreates the solute and solvent dict in the case where the solvents have changed.</span>
<span class="sd">    Args:</span>
<span class="sd">        solvent_dict (dict): The old solvent dict of (key,index) pairs</span>
<span class="sd">        solute_dict (dict): The old solute dict of (key,arr) pairs</span>
<span class="sd">        solvents (dict): The new list of solvents</span>
<span class="sd">    Returns:</span>
<span class="sd">        new_solvent_dict (dict): New set of (key,index) pairs</span>
<span class="sd">        new_solute_dict (dict): New set of (key,arr) pairs</span>
<span class="sd">    </span>
<span class="sd">    Note: This can be called less frequently if you allow solvents with zero amount to persist</span>
<span class="sd">    in the materials dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># needs to be called when adding or removing solvents (after you set the</span>
    <span class="c1"># mols dissolved in any removed solvents to 0)</span>
    <span class="n">new_solvent_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">mat</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">solvents</span><span class="p">)}</span>
    <span class="n">new_solute_dict</span> <span class="o">=</span> \
    <span class="p">{</span><span class="n">mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">solute_dict</span><span class="p">[</span><span class="n">mat</span><span class="p">][</span><span class="n">solvent_dict</span><span class="p">[</span><span class="n">sol</span><span class="p">]]</span> <span class="k">if</span> <span class="n">sol</span> <span class="ow">in</span> <span class="n">solvent_dict</span> <span class="k">else</span> <span class="mi">0</span> 
        <span class="k">for</span> <span class="n">sol</span> <span class="ow">in</span> <span class="n">solvents</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">solute_dict</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">new_solvent_dict</span><span class="p">,</span> <span class="n">new_solute_dict</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_validate_solute_amounts</span><span class="p">(</span><span class="n">mol_solute</span><span class="p">,</span> <span class="n">mol_solvent</span><span class="p">,</span> <span class="n">mol_dissolved</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a series of consistency checks on the mol_dissolved array.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol_solute (array): The total amount of each solute in the vessel (1D, size N)</span>
<span class="sd">        mol_solvent (array): The total amount of each solvent in the vessel (1D, size M)</span>
<span class="sd">        mol_dissolved (array) The amount of solute dissolved in each solvent (2D, shape [N,M])</span>
<span class="sd">    </span>
<span class="sd">    Checks:</span>
<span class="sd">    - Make sure the sum of each row in mol_dissolved is equal to the value in mol_solute</span>
<span class="sd">    - Strategies: Increase proportional to how much solvent there is</span>
<span class="sd">                      Decrease proportional to how much is already dissolved</span>
<span class="sd">    - Make sure each column of mol_dissolved if the corresponding value in mol_solvent is 0</span>
<span class="sd">    - Strategies: Set columns to 0 before doing the sum check if there is no solvent</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First make sure there are solvents</span>
    <span class="n">tot_solvent</span><span class="o">=</span><span class="n">mol_solvent</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tot_solvent</span><span class="o">&lt;</span><span class="mf">1e-12</span><span class="p">:</span>
        <span class="n">mol_dissolved</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">return</span>
    <span class="c1">#get normalized solvent amounts</span>
    <span class="n">norm_solvent</span><span class="o">=</span><span class="n">mol_solvent</span><span class="o">/</span><span class="n">tot_solvent</span>
    <span class="c1">#Make sure there are no solutes in empty solvents</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">v_mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_solvent</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v_mol</span><span class="o">&lt;</span><span class="mf">1e-12</span><span class="p">:</span>
            <span class="n">mol_dissolved</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="c1">#make sure the sums consistent</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">u_mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_solute</span><span class="p">):</span>
        <span class="n">checksum</span><span class="o">=</span><span class="n">mol_dissolved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1">#Set to zero if very close</span>
        <span class="k">if</span> <span class="n">u_mol</span><span class="o">&lt;</span><span class="mf">1e-16</span><span class="p">:</span>
            <span class="n">mol_dissolved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="c1">#Decrease amounts proportional to what&#39;s in each solvent</span>
        <span class="k">elif</span> <span class="n">checksum</span><span class="o">&gt;</span><span class="n">u_mol</span><span class="p">:</span>
            <span class="n">mol_dissolved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="n">u_mol</span><span class="o">/</span><span class="n">checksum</span><span class="p">)</span>
        <span class="c1">#But increase amounts proportional to how much solvent there is</span>
        <span class="k">elif</span> <span class="n">checksum</span><span class="o">&lt;</span><span class="n">u_mol</span><span class="p">:</span>
            <span class="n">mol_dissolved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u_mol</span><span class="o">-</span><span class="n">checksum</span><span class="p">)</span><span class="o">*</span><span class="n">norm_solvent</span>


<span class="n">layer_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">-</span><span class="mf">1.9e-2</span>

<div class="viewcode-block" id="Vessel"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel">[docs]</a><span class="k">class</span> <span class="nc">Vessel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Vessel class serves as any container you might find in a lab, a beaker, a dripper, etc. </span>
<span class="sd">    It simulates actions performed within a lab, such as draining contents, performing reactions, </span>
<span class="sd">    mixing, pouring, etc. </span>

<span class="sd">    The most important method is :meth:`~Vessel.push_event_to_queue` . The rest of the functions are</span>
<span class="sd">    either handeled in the backend or getter methods.</span>

<span class="sd">    These are the default :class:`Event` functions:</span>

<span class="sd">    +------------------+-----------------------------------------------------+-----------------------------------------+</span>
<span class="sd">    | Event Name       | Event Description                                   | Event Parameters                        |</span>
<span class="sd">    +==================+=====================================================+=========================================+</span>
<span class="sd">    |  pour by volume  | Pour from self vessel to target vessel by certain   |   volume (:class:`python:float`)        |</span>
<span class="sd">    |                  | volume                                              |                                         |</span>
<span class="sd">    +------------------+-----------------------------------------------------+-----------------------------------------+</span>
<span class="sd">    |  pour by percent | Pour a fraction of all contents in one vessel into  |   fraction (:class:`python:float`)      |</span>
<span class="sd">    |                  | another                                             |                                         |</span>
<span class="sd">    +------------------+-----------------------------------------------------+-----------------------------------------+</span>
<span class="sd">    |  drain by pixel  | Drain from self vessel to target vessel by certain  |   n_pixel (:class:`python:int`)         |</span>
<span class="sd">    |                  | pixel                                               |                                         |</span>
<span class="sd">    +------------------+-----------------------------------------------------+-----------------------------------------+</span>
<span class="sd">    |  mix             | Shake the vessel or let it settle                   |   t (:class:`python:float`)             |</span>
<span class="sd">    +------------------+-----------------------------------------------------+-----------------------------------------+</span>
<span class="sd">    |  update_layer    | Update self vessel&#39;s layer representation           |                                         |</span>
<span class="sd">    +------------------+-----------------------------------------------------+-----------------------------------------+</span>
<span class="sd">    |  change heat     | Add or remove heat from the vessel                  |   dQ (:class:`python:float`)            |</span>
<span class="sd">    +------------------+-----------------------------------------------------+-----------------------------------------+</span>
<span class="sd">    |  heat contact    | Connect the vessel to a reservoir for heat transfer | Tf (float), ht (float)                  |</span>
<span class="sd">    +------------------+-----------------------------------------------------+-----------------------------------------+</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
            <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">297.0</span><span class="p">,</span> 
            <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> 
            <span class="n">ignore_layout</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            label (str): Name for the vessel</span>
<span class="sd">            temperature (float): Temperature of the vessel in Kelvin</span>
<span class="sd">            volume (float): Volume of the vessel in Litres</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Functions to implement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">=</span><span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_dt</span><span class="o">=</span><span class="mf">0.01</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">=</span><span class="n">volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span> <span class="c1"># String keys, Material values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span> <span class="c1"># String Keys, float array values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solvent_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span> <span class="c1">#String Keys, index values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layers_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layers_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">/</span><span class="mf">3.46</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layer_volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_variance</span> <span class="o">=</span> <span class="mf">1e-5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_layout</span><span class="o">=</span><span class="n">ignore_layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layer_mats</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>

<div class="viewcode-block" id="Vessel.validate_solutes"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.validate_solutes">[docs]</a>    <span class="k">def</span> <span class="nf">validate_solutes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checksum</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns the solute dict into a 2D array, gets a 1D array</span>
<span class="sd">        of solute amounts, as well as a 1D array of solvent amounts, then</span>
<span class="sd">        performs consistency checks with _validate_solute_amounts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_layout</span><span class="p">:</span><span class="k">return</span>
        <span class="n">n_solvents</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="p">)</span>
        <span class="c1">#gather a list of solutes</span>
        <span class="n">solutes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">is_solute</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">n_solvents</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">solutes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span><span class="k">return</span>
        <span class="c1">#get mol information for solutes and solvents</span>
        <span class="n">solute_mols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">solutes</span><span class="p">])</span>
        <span class="n">solvent_mols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="p">])</span>

        <span class="c1">#get all of the dissolved amounts</span>
        <span class="n">null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_solvents</span><span class="p">)</span>
        <span class="n">old_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span>
        <span class="n">mol_dissolved</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">old_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">old_dict</span> <span class="k">else</span> <span class="n">null</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">solutes</span><span class="p">])</span>
        <span class="c1">#run the validation</span>
        <span class="n">_validate_solute_amounts</span><span class="p">(</span><span class="n">solute_mols</span><span class="p">,</span> <span class="n">solvent_mols</span><span class="p">,</span> <span class="n">mol_dissolved</span><span class="p">)</span>
        <span class="c1">#set the new solute dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="o">=</span><span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">mol_dissolved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">solutes</span><span class="p">)}</span></div>

<div class="viewcode-block" id="Vessel.validate_solvents"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.validate_solvents">[docs]</a>    <span class="k">def</span> <span class="nf">validate_solvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the solute_dict and solvent_dict / solvent array when the solvents have changed</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_layout</span><span class="p">:</span><span class="k">return</span>
        <span class="n">new_solvents</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">is_solvent</span><span class="p">())</span>
        <span class="c1">#union should be the same length as both new_solvents and solvents</span>
        <span class="n">union</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_solvents</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvent_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_solvents</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_solvents</span><span class="p">)</span><span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">union</span><span class="p">)</span> <span class="p">:</span>

            <span class="c1">#copy over variances</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers_variance</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">solvent_dict</span><span class="p">[</span><span class="n">sol</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">sol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvent_dict</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">sol</span> <span class="ow">in</span> <span class="n">new_solvents</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers_variance</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="c1">#copy over amounts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layer_volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_layer_volumes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">solvent_dict</span><span class="p">[</span><span class="n">sol</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">sol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvent_dict</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">sol</span> <span class="ow">in</span> <span class="n">new_solvents</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_layer_volumes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="c1">#make a new solvent dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solvent_dict</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span> <span class="o">=</span> <span class="n">_rebuild_solute_dict</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solvent_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="p">,</span> <span class="n">new_solvents</span>
            <span class="p">)</span>
            
            <span class="n">n_solvents</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">new_solvents</span><span class="p">)</span>
            <span class="c1"># If we went from 0 to 1+ solvents we need to dissolve the solutes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">n_solvents</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">arr</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">/</span><span class="n">n_solvents</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="o">=</span><span class="n">new_solvents</span>
            <span class="c1">#last entry is for air</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_solvents</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_handle_overflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses flled_volume() to determine if there is an overflow, if yes, it dumps a proportion</span>
<span class="sd">        of the vessel contents in order to have filled_volume &lt;= volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled_volume</span><span class="p">()</span>
        <span class="c1"># decrease everything proportionally  and return -1 if there is an overflow</span>
        <span class="k">if</span> <span class="n">filled</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">/</span><span class="n">filled</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">mat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">mol</span><span class="o">*=</span><span class="n">ratio</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">arr</span><span class="o">*=</span><span class="n">ratio</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="Vessel.heat_capacity"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.heat_capacity">[docs]</a>    <span class="k">def</span> <span class="nf">heat_capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            float: The sum of the heat capacities of all materials in the vessel (in J/K)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C_air</span> <span class="o">=</span> <span class="mf">1.2292875</span> <span class="c1">#Heat capacity of air in J/L*K (near STP)</span>
        <span class="c1">#Adding in an approximate heat capacity for the air</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">*</span><span class="n">C_air</span><span class="o">+</span><span class="nb">sum</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">heat_capacity</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">mat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>

<div class="viewcode-block" id="Vessel.filled_volume"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.filled_volume">[docs]</a>    <span class="k">def</span> <span class="nf">filled_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            float: The volume of all non-gas phase materials in the vessel (in Litres).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">litres</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">mat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>

<div class="viewcode-block" id="Vessel.get_material_dataframe"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.get_material_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_material_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            :class:`~pandas.DataFrame`: A DataFrame detailing all materials present in the Vessel.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:(</span><span class="n">mat</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">is_solute</span><span class="p">(),</span><span class="n">mat</span><span class="o">.</span><span class="n">is_solvent</span><span class="p">())</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">mat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">info_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Amount&quot;</span><span class="p">,</span><span class="s2">&quot;Phase&quot;</span><span class="p">,</span><span class="s2">&quot;Solute&quot;</span><span class="p">,</span><span class="s2">&quot;Solvent&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Vessel.get_solute_dataframe"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.get_solute_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_solute_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            :class:`~pandas.DataFrame`: A [solutes, solvents] DataFrame detailing how much solute is dissolved in each solvent.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="p">)</span></div>

<div class="viewcode-block" id="Vessel.get_layer_dataframe"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.get_layer_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_layer_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            :class:`~pandas.DataFrame`: A DataFrame containing the layer information of the vessel.  </span>
<span class="sd">        &quot;&quot;&quot;</span>                    
        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">mat</span><span class="o">.</span><span class="n">_name</span><span class="p">:(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_volume</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_position</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lvar</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layer_colors</span><span class="p">[</span><span class="n">i</span><span class="p">],)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layer_mats</span><span class="p">)}</span>

        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;air&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_volume</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_position</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lvar</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layer_colors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">info_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span><span class="s2">&quot;position&quot;</span><span class="p">,</span><span class="s2">&quot;variance&quot;</span><span class="p">,</span><span class="s2">&quot;color&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Vessel.push_event_to_queue"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.push_event_to_queue">[docs]</a>    <span class="k">def</span> <span class="nf">push_event_to_queue</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">events</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Event</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(),</span> 
            <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">update_layers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function calls a set of event functions in sequence specified by `events`, then returns</span>
<span class="sd">        a tuple of status codes (one for each event).</span>

<span class="sd">        Args:</span>
<span class="sd">            events (Tuple[Event]): The sequence of events to be executed.</span>
<span class="sd">            dt (float): The amount of time elapsed (defaults to 0).</span>
<span class="sd">            update_layers (bool): Whether or not to update layer information at the end of the queue.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[int]: A sequence of status codes for each event. At the moment, 0 represents normal execution,</span>
<span class="sd">            and -1 represents an illegal state reached (like a vessel overflow or boiling an empty vessel).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_dict</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_event_dict</span>
        <span class="n">status</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_dict</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">other_vessel</span><span class="p">,</span> <span class="o">*</span><span class="n">event</span><span class="o">.</span><span class="n">parameter</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_layout</span><span class="p">)</span> <span class="ow">and</span> <span class="n">update_layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_layers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">status</span></div>

    <span class="k">def</span> <span class="nf">_heat_contact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">other_vessel</span><span class="p">,</span> <span class="n">Tf</span><span class="p">,</span> <span class="n">ht</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rough Estimate of heat transfer so we can simulate putting something on a bunson burner</span>
<span class="sd">        or in a water bath.</span>
<span class="sd">        Param:</span>
<span class="sd">        - Tf (Optional[float]): The temperature of the heat source</span>
<span class="sd">        - ht (float): heat transfer coeff multiplied by how long you have</span>
<span class="sd">        </span>
<span class="sd">        Note: When T is None, ht will be used as heat Q</span>
<span class="sd">        Steps:</span>
<span class="sd">            1. Calculate total heat capacity of the vessel</span>
<span class="sd">            2. Get T estimate from heat capacity equation &amp; Newton&#39;s law of heat transfer</span>
<span class="sd">            3. While T estimate is above the lowest boiling point of your materials</span>
<span class="sd">                i. Subtract d_ht required to get to boiling point from ht</span>
<span class="sd">                ii. Get boiling enthalpy of your material and calculate how much will boil</span>
<span class="sd">                iii. Boil off material and subtract the necessary d_ht used from ht</span>
<span class="sd">                iv. Calculate new T estimate based off of your new ht value</span>
<span class="sd">            4. set vessel temperature to T</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_dQ</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_dQ</span><span class="p">:</span>
            <span class="c1"># Adding heat (dQ) is the same as linearly approximating the exponential and log functions and setting</span>
            <span class="c1"># The reservoir temperature to one unit above the current temperature (trust me)</span>
            <span class="n">exp</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">Tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ln</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span>
            <span class="n">exp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span>


        <span class="n">other_mats</span><span class="o">=</span><span class="n">other_vessel</span><span class="o">.</span><span class="n">material_dict</span>
        <span class="c1"># Estimated final temperature before taking boiling into account</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Tf</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="o">-</span><span class="n">Tf</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ht</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">())</span>

        <span class="n">mdict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span>
        <span class="c1">#case for changing the heat of an empty vessel</span>
        <span class="n">total_mats</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">mat</span> <span class="ow">in</span> <span class="n">mdict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">total_mats</span><span class="o">&lt;</span><span class="mf">1e-12</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">T</span>
            <span class="c1"># -1 if placing an empty beaker on something hot</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">Tf</span><span class="o">&lt;</span><span class="mi">373</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1">#get sorted boiling points</span>
        <span class="n">bp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span><span class="n">mdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">_boiling_point</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">],</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">key</span><span class="p">,</span><span class="n">boil</span><span class="o">=</span><span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">T</span><span class="o">&gt;</span><span class="n">boil</span> <span class="ow">and</span> <span class="n">T</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">:</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">mdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="c1">#amount of transfer-time required to reach boiling temperature</span>
            <span class="n">ht</span> <span class="o">+=</span> <span class="n">ln</span><span class="p">((</span><span class="n">Tf</span><span class="o">-</span><span class="n">boil</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Tf</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">()</span> <span class="c1">#i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">boil</span> <span class="c1">#i</span>
            <span class="k">if</span> <span class="n">use_dQ</span><span class="p">:</span> <span class="n">Tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">boil_enthalpy</span><span class="o">=</span><span class="n">material</span><span class="o">.</span><span class="n">vapour_enthalpy</span> <span class="c1">#ii</span>
            <span class="c1"># ht = dQ/(T_f-T_boil)</span>
            <span class="n">ht_used</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span><span class="n">boil_enthalpy</span><span class="o">/</span><span class="p">(</span><span class="n">Tf</span><span class="o">-</span><span class="n">boil</span><span class="p">))</span> <span class="c1">#ii</span>
            <span class="n">ht</span><span class="o">-=</span><span class="n">ht_used</span> <span class="c1">#iii</span>
            <span class="c1"># Move the boiled material (iii)</span>
            <span class="n">fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">ht_used</span><span class="o">*</span><span class="p">(</span><span class="n">Tf</span><span class="o">-</span><span class="n">boil</span><span class="p">)</span><span class="o">/</span><span class="n">boil_enthalpy</span><span class="p">)</span> <span class="k">if</span> <span class="n">ht_used</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">other_mats</span><span class="p">:</span>
                <span class="n">d_mol</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">mol</span><span class="o">*</span><span class="n">fraction</span>
                <span class="n">other_mats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="o">+=</span> <span class="n">d_mol</span>
                <span class="n">material</span><span class="o">.</span><span class="n">mol</span> <span class="o">-=</span> <span class="n">d_mol</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other_mats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">ration</span><span class="p">(</span><span class="n">fraction</span><span class="p">)</span>

            <span class="c1">#Heat capacity is called again since it should be lower now</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">Tf</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="o">-</span><span class="n">Tf</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ht</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">())</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="nb">len</span><span class="p">(</span><span class="n">bp</span><span class="p">):</span><span class="k">break</span>
            <span class="n">key</span><span class="p">,</span><span class="n">boil</span><span class="o">=</span><span class="n">bp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="o">=</span><span class="n">T</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_solutes</span><span class="p">()</span>
        <span class="n">other_vessel</span><span class="o">.</span><span class="n">validate_solvents</span><span class="p">()</span>
        <span class="n">other_vessel</span><span class="o">.</span><span class="n">validate_solutes</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">other_vessel</span><span class="o">.</span><span class="n">_handle_overflow</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_change_heat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">other_vessel</span><span class="p">,</span> <span class="n">dQ</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Depricated function, consider using heat contact instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heat_contact</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">other_vessel</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dQ</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_pour_by_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">other_vessel</span><span class="p">,</span> <span class="n">fraction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - Take each material in this vessel and transfer it&#39;s amount * fraction</span>
<span class="sd">            to other_vessel</span>
<span class="sd">        - Check for overflow at the end</span>
<span class="sd">        - Dumping in contents should mix other_vessel</span>

<span class="sd">        TODO: Consider making this call a theoretical _add_materials function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fraction</span><span class="o">&lt;</span><span class="mf">1e-16</span><span class="p">:</span><span class="k">return</span> <span class="mi">0</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">fraction</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">other_mats</span><span class="o">=</span><span class="n">other_vessel</span><span class="o">.</span><span class="n">material_dict</span>
        <span class="c1">#Iterate through each material in the vessel</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">mat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">is_solute</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fraction</span><span class="p">)</span>
            <span class="c1"># Update other vessel&#39;s material dict</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">other_mats</span><span class="p">:</span>
                <span class="n">other_mats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">+=</span><span class="n">mat</span><span class="o">.</span><span class="n">mol</span><span class="o">*</span><span class="n">fraction</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">mol</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fraction</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get new material with the same class as mat using ration</span>
                <span class="n">other_mats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">ration</span><span class="p">(</span><span class="n">fraction</span><span class="p">)</span>

        <span class="c1"># Rebuild the other vessel&#39;s solute dict if new solvents have been added</span>
        <span class="n">other_vessel</span><span class="o">.</span><span class="n">validate_solvents</span><span class="p">()</span>
        <span class="n">other_vessel</span><span class="o">.</span><span class="n">validate_solutes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">other_vessel</span><span class="o">.</span><span class="n">_handle_overflow</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_pour_by_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">other_vessel</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pour the same as _pour_by_percent but the fraction is determined by how much volume you want</span>
<span class="sd">        to pour vs how much of the vessel is filled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filled_volume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filled_volume</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filled_volume</span><span class="o">&lt;</span><span class="mf">1e-12</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">volume</span><span class="o">/</span><span class="n">filled_volume</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pour_by_percent</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">other_vessel</span><span class="p">,</span> <span class="n">fraction</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_drain_by_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">other_vessel</span><span class="p">,</span> <span class="n">n_pixel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This uses layer information to drain out the bottom N layers</span>
<span class="sd">        For each solvent:</span>
<span class="sd">            i. Figure out how much solvent is in the bottom N pixels and drain that</span>
<span class="sd">            ii. Figure out how much of EACH solute is dissolved in that bit of solvent and drain those</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_layout</span><span class="p">:</span><span class="k">return</span> <span class="o">-</span><span class="mi">2</span>

        <span class="n">other_mats</span><span class="o">=</span><span class="n">other_vessel</span><span class="o">.</span><span class="n">material_dict</span>

        <span class="n">drained_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hashed_layers</span><span class="p">[:</span><span class="n">n_pixel</span><span class="p">]</span>
        <span class="n">tot_pixels</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hashed_layers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="p">):</span>
            <span class="c1">#NOTE mat is the solvent material</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">drained_volume</span> <span class="o">=</span> <span class="p">(</span><span class="n">drained_layers</span><span class="o">==</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">tot_pixels</span>
            <span class="k">if</span> <span class="n">drained_volume</span><span class="o">&lt;=</span><span class="mf">1e-12</span><span class="p">:</span><span class="k">continue</span>
            <span class="c1">#how much solvent is drained (percent wise)</span>
            <span class="n">fraction</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">drained_volume</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers_volume</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">litres</span><span class="o">&lt;</span><span class="mf">1e-12</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DEBUG</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hashed_layers</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">solvents</span>
            <span class="c1">#drain out the solvent</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">other_mats</span><span class="p">:</span>
                <span class="n">d_mol</span><span class="o">=</span><span class="n">mat</span><span class="o">.</span><span class="n">mol</span><span class="o">*</span><span class="n">fraction</span>
                <span class="n">other_mats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">+=</span><span class="n">d_mol</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">mol</span> <span class="o">-=</span> <span class="n">d_mol</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other_mats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">ration</span><span class="p">(</span><span class="n">fraction</span><span class="p">)</span>
            <span class="c1">#drain the solutes</span>
            <span class="k">for</span> <span class="n">u_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="p">:</span>
                <span class="c1">#NOTE u_mat is the solute material</span>
                <span class="n">u_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="p">[</span><span class="n">u_key</span><span class="p">]</span>
                <span class="n">removed_amount</span> <span class="o">=</span> <span class="n">fraction</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="p">[</span><span class="n">u_key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="c1">#update the solute dict properly</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="p">[</span><span class="n">u_key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">removed_amount</span>
                <span class="k">if</span> <span class="n">removed_amount</span><span class="o">&lt;=</span><span class="mf">1e-12</span><span class="p">:</span><span class="k">continue</span>
                <span class="c1">#drain out the solute</span>
                <span class="k">if</span> <span class="n">u_key</span> <span class="ow">in</span> <span class="n">other_mats</span><span class="p">:</span>
                    <span class="n">other_mats</span><span class="p">[</span><span class="n">u_key</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">+=</span><span class="n">removed_amount</span>
                    <span class="n">u_mat</span><span class="o">.</span><span class="n">mol</span> <span class="o">-=</span> <span class="n">removed_amount</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other_mats</span><span class="p">[</span><span class="n">u_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_mat</span><span class="o">.</span><span class="n">ration</span><span class="p">(</span><span class="n">removed_amount</span><span class="o">/</span><span class="n">u_mat</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">other_vessel</span><span class="o">.</span><span class="n">validate_solvents</span><span class="p">()</span>
        <span class="n">other_vessel</span><span class="o">.</span><span class="n">validate_solutes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">other_vessel</span><span class="o">.</span><span class="n">_handle_overflow</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_mix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">other_vessel</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Realistically just a wrapper for separate.mix</span>

<span class="sd">        This updates the amounts dissolved, layer positions and layer variances  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_layout</span><span class="p">:</span><span class="k">return</span> <span class="o">-</span><span class="mi">2</span>
        <span class="n">t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c1">#or replace dt</span>
        <span class="c1"># Make air layer properties</span>
        <span class="n">d_air</span> <span class="o">=</span> <span class="mf">1.225</span> <span class="c1">#in g/L</span>
        <span class="n">c_air</span> <span class="o">=</span> <span class="mf">0.65</span> <span class="c1">#chosen color of air</span>

        <span class="c1">#This is just to ensure the order of solutes does not change</span>
        <span class="n">s_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="p">)</span>
        <span class="c1">#Grab solute and solvent objects</span>
        <span class="n">solutes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s_names</span><span class="p">)</span>
        <span class="n">solvents</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvents</span><span class="p">]</span>
        <span class="c1">#Get solvent volumes</span>
        

        <span class="n">solute_flag</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">solvents</span><span class="p">)</span><span class="o">&lt;=</span><span class="mf">1e-12</span>
        <span class="n">misc_mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">mat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">material_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">mat</span><span class="o">.</span><span class="n">is_solvent</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">solute_flag</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mat</span><span class="o">.</span><span class="n">is_solute</span><span class="p">())]</span>

        <span class="n">layer_mats</span><span class="o">=</span><span class="n">solvents</span><span class="o">+</span><span class="n">misc_mats</span>

        <span class="n">layer_volume</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat</span><span class="o">.</span><span class="n">litres</span> <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">layer_mats</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_layer_mats</span> <span class="o">=</span> <span class="n">layer_mats</span>

        <span class="c1"># Add air to the end ov the volume list s.t it fills the remainder of the vessel</span>
        <span class="n">layer_volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layer_volume</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">layer_volume</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">layer_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mat</span><span class="o">.</span><span class="n">get_density</span><span class="p">()</span> <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">layer_mats</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">d_air</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layer_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mat</span><span class="o">.</span><span class="n">_color</span> <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">layer_mats</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">c_air</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1">#Exclude air since it&#39;s not a solvent?</span>
        <span class="n">solvent_polarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mat</span><span class="o">.</span><span class="n">polarity</span> <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">solvents</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1">#Get solute properties</span>
        <span class="n">solute_polarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mat</span><span class="o">.</span><span class="n">polarity</span> <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">solutes</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1">#Hopefully this is the correct 2D array shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">solute_amount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s_names</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solute_amount</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">solvents</span><span class="p">)],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">solute_svolume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mat</span><span class="o">.</span><span class="n">litres_per_mol</span> <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">solutes</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_layers_position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_volume</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_variance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variance</span><span class="p">,</span> <span class="n">new_solute_amount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lvar</span> <span class="o">=</span> <span class="n">separate</span><span class="o">.</span><span class="n">mix</span><span class="p">(</span>
            <span class="n">layer_volume</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layer_volumes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">solute_svolume</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_position</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_variance</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_variance</span><span class="p">),</span>
            <span class="n">layer_density</span><span class="p">,</span>
            <span class="n">solute_polarity</span><span class="p">,</span>
            <span class="n">solvent_polarity</span><span class="p">,</span>
            <span class="n">solute_amount</span><span class="p">,</span>
            <span class="n">t</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_layer_volumes</span> <span class="o">=</span> <span class="n">layer_volume</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_names</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solute_dict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_solute_amount</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="mi">0</span>
   
    <span class="k">def</span> <span class="nf">_update_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">other_vessel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This wraps separate.map_to_state</span>
<span class="sd">        It&#39;s used to get a layer image as well as layer information</span>
<span class="sd">        TODO: Handle solutes having a volume</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_hashed_layers</span> <span class="o">=</span> <span class="n">separate</span><span class="o">.</span><span class="n">map_to_state</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_volume</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers_position</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lvar</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layer_colors</span><span class="p">,</span>
            <span class="n">layer_values</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Vessel.get_layers"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.get_layers">[docs]</a>    <span class="k">def</span> <span class="nf">get_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[float]: The color of each vessel layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_layers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span></div>

<div class="viewcode-block" id="Vessel.register"><a class="viewcode-back" href="../../chemistrylab.vessel.html#chemistrylab.vessel.Vessel.register">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The method to register an event function which updates a vessel instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            func (Callable[[Vessel, Tuple, Optional[Vessel]], int]): An event function which acts on one or two vessels.</span>
<span class="sd">            name (str): The name of the event function for registration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot register the same Event (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">) Twice!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">func</span></div>
    
    <span class="c1">#ANY SUBCLASSES SHOULD DEFINE THIS EXPLICITLY!!!</span>
    <span class="n">_event_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pour by volume&#39;</span><span class="p">:</span> <span class="n">_pour_by_volume</span><span class="p">,</span>
            <span class="s1">&#39;pour by percent&#39;</span><span class="p">:</span><span class="n">_pour_by_percent</span><span class="p">,</span>
            <span class="s1">&#39;drain by pixel&#39;</span><span class="p">:</span> <span class="n">_drain_by_pixel</span><span class="p">,</span>
            <span class="s1">&#39;mix&#39;</span><span class="p">:</span> <span class="n">_mix</span><span class="p">,</span>
            <span class="s1">&#39;update layer&#39;</span><span class="p">:</span> <span class="n">_update_layers</span><span class="p">,</span>
            <span class="s1">&#39;change heat&#39;</span><span class="p">:</span> <span class="n">_change_heat</span><span class="p">,</span>
            <span class="s1">&#39;heat contact&#39;</span><span class="p">:</span> <span class="n">_heat_contact</span><span class="p">,</span>
        <span class="p">}</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Chris Beeler, Sriram Ganapathi Subramanian, Kyle Sprague, Nouha Chatti, ColinBellinger, Mitchell Shahen, Nicholas Paquin, Mark Baula, Amanuel Dawit, Zihan Yang,Xinkai Li, Mark Crowley, Isaac Tamblyn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>